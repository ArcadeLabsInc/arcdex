<?php

use App\Models\Nonce;
use Illuminate\Validation\ValidationException;

// App will request a nonce from the API via POST /nonce, passing in pubkey and device_name
// API will generate a nonce and store it in the database
// API will return the nonce to the app
// App will generate a proof by signing the nonce with the private key associated with the pubkey
// App will send the proof, pubkey, and device_name to the API via POST /login
// API will validate the proof was generated by the private key associated with the pubkey
// API will return a token to the app
// App will store the token in local storage
// App will send the token in the Authorization header for all subsequent requests



// App will request a nonce from the API via POST /api/nonce, passing in pubkey and device_name
// LoginController@nonce creates nonce, saves to nonces table with timestamps and pubkey and device_name, returns nonce to the app
test('app can request a nonce', function () {
    $response = $this->post('/api/nonce', [
        'pubkey' => '987612984762893476234',
        'device_name' => 'test device',
    ]);

    $response->assertStatus(200)
        ->assertJsonStructure(['nonce']);

    $nonce = $response->json('nonce');
    expect($response->json('nonce'))->toBeString();

    // check that the nonce is in the database, associated with the pubkey and device_name and that nonce is recent
    $this->assertDatabaseHas('nonces', [
        'pubkey' => '987612984762893476234',
        'device_name' => 'test device',
        'nonce' => $nonce,
    ]);

    // Check that the nonce is in the database, associated with the pubkey and device_name, and that it is recent
    $nonceRow = Nonce::where([
        'pubkey' => '987612984762893476234',
        'device_name' => 'test device',
        'nonce' => $nonce,
    ])->first();

    expect($nonceRow)->not->toBeNull();
});

test('nonce request without pubkey fails', function () {
    $this->withoutExceptionHandling();
    $this->expectException(ValidationException::class);

    $this->post('/api/nonce', [
        'device_name' => 'test device',
    ]);
});

test('nonce request without device_name fails', function () {
    $this->withoutExceptionHandling();
    $this->expectException(ValidationException::class);

    $this->post('/api/nonce', [
        'pubkey' => 'asoidfjoasidjfisjsdf',
    ]);
});


// test('user can log in via api', function () {
//     $user = User::factory()->create();

//     $response = $this->post('/sanctum/token', [
//         'pubkey' => $user->pubkey,
//         'device_name' => 'test device',
//         'proof' => 'test proof',
//     ]);

//     $response->assertStatus(200);
//     $response->assertJsonStructure(['token']);
// });
